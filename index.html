<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GOVINDA PARIWAR - Colony Finance Manager</title>
  <meta name="description" content="Colony Finance Management System for Govinda Pariwar" />
  <meta name="theme-color" content="#21808d" />
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiR292aW5kYSBQYXJpd2FyIEZpbmFuY2UiLCJzaG9ydF9uYW1lIjoiR1AgRmluYW5jZSIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZmNmY2Y5IiwidGhlbWVfY29sb3IiOiIjMjE4MDhkIiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0NzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PScwIDAgMTAwIDEwMCclM0UlM0NyZWN0IHdpZHRoPScxMDAnIGhlaWdodD0nMTAwJyBmaWxsPSclMjMyMTgwOGQnLyUzRSUzQ3RleHQgeD0nNTAnIHk9JzUwJyBmb250LXNpemU9JzUwJyB0ZXh0LWFuY2hvcj0nbWlkZGxlJyBkeT0nLjNlbScgZmlsbD0nd2hpdGUnJTNFRyUzQy90ZXh0JTNFJTNDL3N2ZyUzRSIsInNpemVzIjoiNTEyeDUxMiIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn1dfQ==" />
  <style>
    :root { --color-primary:#21808d; --color-primary-hover:#1d7480; --color-bg:#fcfcf9; --color-surface:#ffffff; --color-text:#13343b; --color-text-light:#626c71; --color-border:#e8e6e1; --color-success:#21808d; --color-error:#c0152f; --color-warning:#e68161; --shadow:0 2px 8px rgba(0,0,0,0.08); }
    @media (prefers-color-scheme: dark){ :root{ --color-bg:#1f2121; --color-surface:#262828; --color-text:#f5f5f5; --color-text-light:#a7a9a9; --color-border:#3a3c3c; --color-primary:#32b8c6; } }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--color-bg);color:var(--color-text);line-height:1.6;font-size:14px}
    .container{max-width:1200px;margin:0 auto;padding:16px;position:relative}
    .header{background:linear-gradient(135deg,var(--color-primary) 0%,#1d7480 100%);color:#fff;padding:24px;border-radius:12px;box-shadow:var(--shadow);margin-bottom:16px;border:1px solid var(--color-border);text-align:center}
    .header h1{font-size:28px;margin-bottom:8px;font-weight:700}
    .header p{font-size:14px;opacity:.9}
    .tabs{display:flex;gap:4px;margin:16px 0 24px;border-radius:12px;background:var(--color-surface);padding:4px;box-shadow:var(--shadow);border:1px solid var(--color-border);overflow-x:auto}
    .tab{flex:1;padding:12px 16px;background:none;border:none;color:var(--color-text-light);cursor:pointer;font-size:14px;font-weight:600;border-radius:8px;transition:background .2s,color .2s;white-space:nowrap;min-width:120px}
    .tab:hover{color:var(--color-text);background:rgba(33,128,141,.08)}
    .tab.active{background:var(--color-primary);color:#fff}
    .card{background:var(--color-surface);border-radius:12px;padding:24px;box-shadow:var(--shadow);margin-bottom:24px;border:1px solid var(--color-border)}
    .card h2{font-size:20px;margin-bottom:20px;display:flex;align-items:center;gap:8px}
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-bottom:24px}
    .stat-box{background:var(--color-surface);padding:20px;border-radius:16px;border:2px solid var(--color-border);box-shadow:var(--shadow);position:relative;overflow:hidden;transition:transform .25s,box-shadow .25s}
    .stat-box:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(0,0,0,.12)}
    .stat-box::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:var(--color-primary)}
    .stat-box.success::before{background:var(--color-success)}
    .stat-box.error::before{background:var(--color-error)}
    .stat-box.warning::before{background:var(--color-warning)}
    .stat-box h3{font-size:12px;color:var(--color-text-light);text-transform:uppercase;margin-bottom:12px;letter-spacing:1px;font-weight:600}
    .stat-box .value{font-size:32px;font-weight:700;line-height:1}
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-bottom:20px}
    .form-group{margin-bottom:20px}
    label{display:block;margin-bottom:8px;font-weight:600;font-size:13px;color:var(--color-text)}
    input,select,textarea{width:100%;padding:12px 16px;border:2px solid var(--color-border);border-radius:8px;font-size:14px;background:var(--color-surface);color:var(--color-text)}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--color-primary);box-shadow:0 0 0 3px rgba(33,128,141,.1)}
    .btn{padding:12px 16px;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
    .btn-primary{background:var(--color-primary);color:#fff}
    .btn-primary:hover{background:var(--color-primary-hover)}
    .btn-secondary{background:var(--color-border);color:var(--color-text)}
    .btn-danger{background:var(--color-error);color:#fff}
    table{width:100%;border-collapse:collapse;font-size:13px;border-radius:8px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    th,td{padding:12px;text-align:left;border-bottom:1px solid var(--color-border)}
    th{background:var(--color-primary);color:#fff;font-weight:600;font-size:12px;text-transform:uppercase}
    .badge{display:inline-block;padding:6px 12px;border-radius:20px;font-size:11px;font-weight:600}
    .badge-success{background:rgba(33,128,141,.15);color:var(--color-success);border:1px solid rgba(33,128,141,.3)}
    .badge-pending{background:rgba(230,129,97,.15);color:var(--color-warning);border:1px solid rgba(230,129,97,.3)}
    .badge-danger{background:rgba(192,21,47,.15);color:var(--color-error);border:1px solid rgba(192,21,47,.3)}
    .overflow-x{overflow-x:auto;border-radius:8px}
    .tab-content{display:none;opacity:0;transition:opacity .35s ease-in-out}
    .tab-content.active{display:block;opacity:1}
    @media (max-width:768px){.tabs{gap:2px}.tab{min-width:100px;font-size:12px;padding:10px 12px}.stat-box .value{font-size:26px}}
  </style>
</head>
<body>
  <div class="container app-container">
    <div class="header"><h1>GOVINDA PARIWAR</h1><p>Accounts - FY 2025 - 2026</p></div>

    <div class="tabs">
      <button class="tab active" data-tab="overview" onclick="switchTab('overview')">üìä Overview</button>
      <button class="tab" data-tab="members" onclick="switchTab('members')">üë• Members</button>
      <button class="tab" data-tab="payments" onclick="switchTab('payments')">üí∞ Payments</button>
      <button class="tab" data-tab="monthly" onclick="switchTab('monthly')">üìÖ Monthly Report</button>
      <button class="tab" data-tab="expenses" onclick="switchTab('expenses')">üí∏ Expenses</button>
      <button class="tab" data-tab="reports" onclick="switchTab('reports')">üìã Reports</button>
    </div>

    <!-- Overview Tab -->
    <div id="overview" class="tab-content active">
      <div class="stats">
        <div class="stat-box"><h3>Total Members</h3><div class="value" id="totalMembers">0</div></div>
        <div class="stat-box success"><h3>Total Collected</h3><div class="value" id="totalCollected">‚Çπ0</div></div>
        <div class="stat-box error"><h3>Total Expenses</h3><div class="value" id="totalExpenses">‚Çπ0</div></div>
        <div class="stat-box warning"><h3>Net Balance</h3><div class="value" id="netBalance">‚Çπ0</div></div>
      </div>
      <div class="card"><h2>üìà Recent Activity</h2><div id="recentActivity"><p style="color:var(--color-text-light);text-align:center;padding:20px;">Recent payments and expenses will appear here</p></div></div>
    </div>

    <!-- Members Tab -->
    <div id="members" class="tab-content">
      <div class="card">
        <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;">
          <h2>üë• Member Payment Overview</h2>
          <div>
            <button class="btn btn-primary btn-sm" onclick="showAddMember()">‚ûï Add Member</button>
            <button class="btn btn-secondary btn-sm" onclick="exportMembers()">üì§ Export CSV</button>
          </div>
        </div>
        <div class="search-box" style="position:relative;margin:12px 0 20px;">
          <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);">üîç</span>
          <input type="text" id="memberSearch" placeholder="Search members..." onkeyup="loadMembers()" style="padding-left:40px;" />
        </div>
        <div class="overflow-x">
          <table id="membersOverviewTable">
            <thead><tr id="membersOverviewHeader"></tr></thead>
            <tbody id="membersOverviewBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Payments Tab -->
    <div id="payments" class="tab-content">
      <div class="card">
        <h2>üí∞ Record Payment</h2>
        <form id="paymentForm">
          <div class="form-grid">
            <div class="form-group"><label>Member</label><select id="paymentMember" required><option value="">Select Member</option></select></div>
            <div class="form-group"><label>Month</label><input type="month" id="paymentMonth" required /></div>
            <div class="form-group"><label>Amount (‚Çπ)</label><input type="number" id="paymentAmount" required /></div>
            <div class="form-group"><label>Payment Method</label><select id="paymentMethod"><option>Cash</option><option>Bank Transfer</option><option>UPI</option><option>Cheque</option></select></div>
          </div>
          <div class="form-group"><label>Notes</label><textarea id="paymentNotes" rows="2" placeholder="Optional notes..."></textarea></div>
          <button type="submit" class="btn btn-primary">üíæ Record Payment</button>
        </form>
      </div>
      <div class="card">
        <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;" class="mb-16"><h2>üí≥ Payment History</h2><button class="btn btn-secondary btn-sm" onclick="exportPayments()">üì§ Export CSV</button></div>
        <div class="overflow-x">
          <table>
            <thead><tr><th>Date</th><th>Member</th><th>Month</th><th>Amount</th><th>Method</th><th>Actions</th></tr></thead>
            <tbody id="paymentsBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Monthly Report Tab -->
    <div id="monthly" class="tab-content">
      <div class="card">
        <div class="form-group"><label>üìÖ Select Month for Report</label><input type="month" id="reportMonth" onchange="updateMonthReport()" /></div>
        <div class="stats mt-16">
          <div class="stat-box"><h3>Expected Collection</h3><div class="value" id="monthExpected">‚Çπ0</div></div>
          <div class="stat-box success"><h3>Actual Collection</h3><div class="value" id="monthCollected">‚Çπ0</div></div>
          <div class="stat-box error"><h3>Month Expenses</h3><div class="value" id="monthExpenses">‚Çπ0</div></div>
          <div class="stat-box warning"><h3>Month Balance</h3><div class="value" id="monthBalance">‚Çπ0</div></div>
        </div>
        <h2 class="mt-16 mb-16">üìä Member Payment Status</h2>
        <div class="overflow-x">
          <table>
            <thead><tr><th>Flat</th><th>Name</th><th>Monthly Fee</th><th>Amount Paid</th><th>Due Amount</th><th>Status</th><th>Unpaid Months</th></tr></thead>
            <tbody id="monthPaymentBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Expenses Tab -->
    <div id="expenses" class="tab-content">
      <div class="card">
        <h2>üí∏ Add Expense</h2>
        <form id="expenseForm">
          <div class="form-grid">
            <div class="form-group"><label>Date</label><input type="date" id="expenseDate" required /></div>
            <div class="form-group"><label>Category</label><select id="expenseCategory" required><option value="">Select Category</option><option>Maintenance</option><option>Repair & Renovation</option><option>Security</option><option>Utilities</option><option>Cleaning</option><option>Landscaping</option><option>Insurance</option><option>Legal</option><option>Other</option></select></div>
            <div class="form-group"><label>Amount (‚Çπ)</label><input type="number" id="expenseAmount" required /></div>
            <div class="form-group"><label>Vendor/Payee</label><input type="text" id="expenseVendor" required /></div>
          </div>
          <div class="form-group"><label>Description</label><textarea id="expenseDescription" rows="2" required></textarea></div>
          <div class="form-group"><label>Receipt/Invoice (Optional)</label><input type="file" id="expenseReceipt" accept="image/*,.pdf" /></div>
          <button type="submit" class="btn btn-primary">üíæ Add Expense</button>
        </form>
      </div>
      <div class="card">
        <div style="display:flex; gap:12px; align-items:center; justify-content:space-between;" class="mb-16">
          <h2>üìã All Expenses</h2>
          <button class="btn btn-secondary btn-sm" onclick="exportExpenses()">üì§ Export CSV</button>
        </div>
        <div class="overflow-x">
          <table>
            <thead><tr><th>Date</th><th>Category</th><th>Description</th><th>Vendor</th><th>Amount</th><th>Receipt</th><th>Actions</th></tr></thead>
            <tbody id="expensesBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Reports Tab -->
    <div id="reports" class="tab-content">
      <div class="card">
        <h2>üìä Financial Reports</h2>
        <div class="form-grid">
          <div class="form-group"><label>Report Type</label><select id="reportType" onchange="generateReport()"><option value="">Select Report</option><option value="summary">Financial Summary</option><option value="defaulters">Payment Defaulters</option><option value="expenses">Expense Analysis</option><option value="monthly">Monthly Breakdown</option></select></div>
          <div class="form-group"><label>From Date</label><input type="month" id="reportFrom" /></div>
          <div class="form-group"><label>To Date</label><input type="month" id="reportTo" /></div>
        </div>
        <div style="display:flex; gap:12px; align-items:center;">
          <button class="btn btn-primary" onclick="generateReport()">üìà Generate Report</button>
          <button class="btn btn-secondary" onclick="exportReport()">üì§ Export Report</button>
        </div>
      </div>
      <div class="card" id="reportResults">
        <h2>üìã Report Results</h2>
        <div id="reportContent"><p style="color: var(--color-text-light); text-align: center; padding: 20px;">Select a report type and click generate to view results</p></div>
      </div>
    </div>

    <!-- Add Member Modal -->
    <div id="addMemberModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; padding:20px;">
      <div style="background:var(--color-surface); max-width:500px; margin:50px auto; padding:24px; border-radius:12px; max-height:90vh; overflow-y:auto;">
        <h2>‚ûï Add New Member</h2>
        <form id="addMemberForm">
          <div class="form-group"><label>Flat Number</label><input type="text" id="newFlat" required /></div>
          <div class="form-group"><label>Name</label><input type="text" id="newName" required /></div>
          <div class="form-group"><label>Monthly Fee (‚Çπ)</label><input type="number" id="newFee" value="1000" required /></div>
          <div class="form-group"><label>Join Date</label><input type="date" id="newJoinDate" required /></div>
          <div class="form-group"><label>Photo (Optional)</label><input type="file" id="newPhoto" accept="image/*" /></div>
          <div style="display:flex; gap:12px; flex-wrap:wrap;">
            <button type="submit" class="btn btn-primary">üíæ Save Member</button>
            <button type="button" class="btn btn-secondary" onclick="hideAddMember()">‚ùå Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Member Details Modal -->
    <div id="memberDetailsModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; padding:20px;">
      <div style="background:var(--color-surface); max-width:500px; margin:50px auto; padding:24px; border-radius:12px; max-height:90vh; overflow-y:auto;">
        <h2 id="memberDetailsName" style="margin-bottom: 16px;"></h2>
        <div style="display:flex; justify-content:space-around; gap: 16px; margin-bottom: 24px;">
          <div class="stat-box success" style="flex:1; padding:16px;">
            <h3>Total Paid</h3><div class="value" id="memberTotalPaid" style="font-size:24px;">‚Çπ0</div>
          </div>
          <div class="stat-box error" style="flex:1; padding:16px;">
            <h3>Total Due</h3><div class="value" id="memberTotalDue" style="font-size:24px;">‚Çπ0</div>
          </div>
        </div>
        <h3 style="margin-bottom:12px; font-size:16px;">Unpaid Months</h3>
        <ul id="memberUnpaidMonths" style="list-style:none; padding:0; margin-top:0;"></ul>
        <button type="button" class="btn btn-secondary" onclick="hideMemberDetails()">Close</button>
      </div>
    </div>
  </div>

  <script>
    // ================== CONFIG ==================
    const API_DATA_URL = '/api/data';
    const STORAGE_KEY = 'gpfr_data_cache';

    // ================== STATE ==================
    let members = [];
    let payments = [];
    let expenses = [];
    let nextPaymentId = 1;
    let nextMemberId = 1;

    // ================== SERVER SYNC (Auto-save) ==================
    async function loadDataFromServer(){
      try{
        const res = await fetch(API_DATA_URL, { cache: 'no-store' });
        if(!res.ok) throw new Error('Failed to fetch');
        const data = await res.json() || {};
        members = Array.isArray(data.members) ? data.members : [];
        payments = Array.isArray(data.payments) ? data.payments : [];
        expenses = Array.isArray(data.expenses) ? data.expenses : [];
        nextMemberId = Number(data.nextMemberId) || (members.length ? Math.max(...members.map(m=>m.id||0))+1 : 1);
        nextPaymentId = Number(data.nextPaymentId) || (payments.length ? Math.max(...payments.map(p=>p.id||0))+1 : 1);
        // cache for offline
        localStorage.setItem(STORAGE_KEY, JSON.stringify({members,payments,expenses,nextMemberId,nextPaymentId}));
      }catch(err){
        console.warn('Server unavailable, using cached data', err);
        try{
          const cached = JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');
          members = cached.members || [];
          payments = cached.payments || [];
          expenses = cached.expenses || [];
          nextMemberId = cached.nextMemberId || 1;
          nextPaymentId = cached.nextPaymentId || 1;
        }catch(e){/* ignore */}
      }
    }

    async function saveDataToServer(){
      const payload = { members, payments, expenses, nextMemberId, nextPaymentId };
      try{
        const res = await fetch(API_DATA_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        if(!res.ok) throw new Error('Save failed');
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      }catch(err){
        console.error('Save failed, caching locally', err);
        try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(payload)); }catch(e){}
        alert('‚ö†Ô∏è Backend not reachable. Changes saved locally; will sync when online.');
      }
    }

    // ================== NAVIGATION ==================
    function setActiveMenu(tabName){
      document.querySelectorAll('.tabs .tab').forEach(btn=>{
        btn.classList.toggle('active', btn.dataset.tab === tabName);
      });
    }
    function switchTab(tabName){
      document.querySelectorAll('.tab-content').forEach(c=>{ c.classList.remove('active'); c.style.display='none'; });
      const active=document.getElementById(tabName);
      if(active){ active.classList.add('active'); active.style.display='block'; }
      setActiveMenu(tabName);
      if(tabName==='members') loadMembers();
      if(tabName==='payments') loadPayments();
      if(tabName==='monthly') updateMonthReport();
      if(tabName==='expenses') loadExpenses();
    }

    // ================== UTIL ==================
    function formatDate(s){ return new Date(s).toLocaleDateString('en-IN'); }
    function formatMonth(m){ const d=new Date(m+'-01'); return d.toLocaleDateString('en-IN',{month:'short',year:'numeric'}); }

    // ================== MEMBERS ==================
    function updatePaymentMemberDropdown(){
      const sel=document.getElementById('paymentMember'); if(!sel) return;
      sel.innerHTML='<option value="">Select Member</option>' + members.map(m=>`<option value="${m.id}">${m.flat} - ${m.name}</option>`).join('');
    }

    function loadMembers(){
      const tbody = document.getElementById('membersOverviewBody');
      const thead = document.getElementById('membersOverviewHeader');
      const search = (document.getElementById('memberSearch')?.value||'').toLowerCase();
      const filtered = members.filter(m => m.name.toLowerCase().includes(search) || m.flat.toLowerCase().includes(search));

      // FY April-March
      const now = new Date(); const fyStart = 3; const months=[]; for(let i=0;i<12;i++){ months.push(new Date(now.getFullYear(), fyStart+i, 1)); }
      thead.innerHTML = `<th>Name</th><th>Paid Months</th><th>Balance Due</th>` + months.map(d=>`<th>${d.toLocaleDateString('en-IN',{month:'short'})}</th>`).join('') + `<th>Actions</th>`;

      tbody.innerHTML = filtered.map(m=>{
        const pays = payments.filter(p=>p.memberId===m.id);
        let paidCount=0, totalPaidAmt=0; let monthCells='';
        months.forEach(d=>{ const key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; const paid=pays.some(p=>p.month===key); if(paid){ paidCount++; totalPaidAmt+=m.fee; } monthCells += `<td>${paid?'‚úì':'‚úó'}</td>`; });
        const balance = (12*m.fee) - totalPaidAmt;
        return `<tr>
          <td>${m.flat} - ${m.name}</td>
          <td>${paidCount}/12</td>
          <td style="color:${balance>0?'var(--color-error)':'var(--color-success)'}">‚Çπ${balance.toLocaleString()}</td>
          ${monthCells}
          <td>
            <div style="display:flex; gap:8px;">
              <button class="btn btn-secondary btn-sm" onclick="editMember(${m.id})">‚úèÔ∏è</button>
              <button class="btn btn-secondary btn-sm" onclick="showMemberDetails(${m.id})">üëÅÔ∏è</button>
              <button class="btn btn-danger btn-sm" onclick="deleteMember(${m.id})">üóëÔ∏è</button>
            </div>
          </td>
        </tr>`;
      }).join('');

      updatePaymentMemberDropdown();
    }

    function showAddMember(){ document.getElementById('addMemberModal').style.display='block'; }
    function hideAddMember(){ const modal=document.getElementById('addMemberModal'); modal.style.display='none'; modal.querySelector('h2').textContent='‚ûï Add New Member'; document.getElementById('addMemberForm').reset(); delete document.getElementById('addMemberForm').dataset.editId; }

    async function deleteMember(id){ const m=members.find(x=>x.id===id); if(!m) return; if(confirm(`Delete ${m.name}? This will also delete payments.`)){ members = members.filter(x=>x.id!==id); payments = payments.filter(p=>p.memberId!==id); await saveDataToServer(); loadMembers(); loadPayments(); updateFinancialSummary(); document.getElementById('totalMembers').textContent = members.length; alert('üóëÔ∏è Member deleted successfully!'); } }

    function editMember(id){ const m=members.find(x=>x.id===id); if(!m) return; document.getElementById('newFlat').value=m.flat; document.getElementById('newName').value=m.name; document.getElementById('newFee').value=m.fee; document.getElementById('newJoinDate').value=m.join; document.getElementById('addMemberForm').dataset.editId=id; document.querySelector('#addMemberModal h2').textContent='‚úèÔ∏è Edit Member'; showAddMember(); }

    // ================== PAYMENTS ==================
    function loadPayments(){
      const tbody=document.getElementById('paymentsBody');
      if(!payments.length){ tbody.innerHTML='<tr><td colspan="6" style="text-align:center;color:var(--color-text-light)">No payments recorded yet</td></tr>'; return; }
      tbody.innerHTML = payments.slice().reverse().map(p=>{ const m=members.find(x=>x.id===p.memberId); return `<tr><td>${formatDate(p.date)}</td><td>${m?m.name:'Unknown'}</td><td>${formatMonth(p.month)}</td><td>‚Çπ${p.amount}</td><td>${p.method}</td><td><button class="btn btn-danger btn-sm" onclick="deletePayment(${p.id})">üóëÔ∏è</button></td></tr>`; }).join('');
    }

    async function deletePayment(id){ if(confirm('Delete this payment?')){ payments = payments.filter(p=>p.id!==id); await saveDataToServer(); loadPayments(); updateFinancialSummary(); alert('üóëÔ∏è Payment deleted!'); } }

    // ================== MONTHLY REPORT ==================
    function getUnpaidMonths(memberId, upToMonth){ const m=members.find(x=>x.id===memberId); if(!m) return []; const joinDate=new Date(m.join); const endDate=new Date(upToMonth+'-01'); const unpaid=[]; const pays=payments.filter(p=>p.memberId===memberId); const cur=new Date(joinDate); while(cur<=endDate){ const key=`${cur.getFullYear()}-${String(cur.getMonth()+1).padStart(2,'0')}`; if(!pays.some(p=>p.month===key)) unpaid.push(formatMonth(key)); cur.setMonth(cur.getMonth()+1);} return unpaid; }

    function updateMonthReport(){ const month=document.getElementById('reportMonth').value; if(!month) return; const monthPays=payments.filter(p=>p.month===month); const collected=monthPays.reduce((s,p)=>s+p.amount,0); const expected=members.reduce((s,m)=>s+m.fee,0); const monthExp=expenses.filter(e=>e.date.startsWith(month)).reduce((s,e)=>s+e.amount,0); document.getElementById('monthExpected').textContent='‚Çπ'+expected.toLocaleString(); document.getElementById('monthCollected').textContent='‚Çπ'+collected.toLocaleString(); document.getElementById('monthExpenses').textContent='‚Çπ'+monthExp.toLocaleString(); document.getElementById('monthBalance').textContent='‚Çπ'+(collected-monthExp).toLocaleString(); const tbody=document.getElementById('monthPaymentBody'); tbody.innerHTML = members.map(m=>{ const paid=monthPays.filter(p=>p.memberId===m.id); const totalPaid=paid.reduce((s,p)=>s+p.amount,0); const due=m.fee-totalPaid; const status= due<=0?'Paid':(totalPaid>0?'Partial':'Pending'); const unpaid=getUnpaidMonths(m.id, month); return `<tr><td>${m.flat}</td><td>${m.name}</td><td>‚Çπ${m.fee}</td><td>‚Çπ${totalPaid}</td><td style="color:${due>0?'var(--color-error)':'var(--color-success)'}">‚Çπ${due}</td><td><span class="badge ${status==='Paid'?'badge-success':(status==='Partial'?'badge-pending':'badge-danger')}">${status}</span></td><td style="font-size:11px; color: var(--color-error)">${unpaid.length?unpaid.join(', '):'-'}</td></tr>`; }).join(''); }

    // ================== EXPENSES ==================
    function loadExpenses(){ const tbody=document.getElementById('expensesBody'); if(!expenses.length){ tbody.innerHTML='<tr><td colspan="7" style="text-align:center;color:var(--color-text-light)">No expenses recorded yet</td></tr>'; } else { tbody.innerHTML = expenses.slice().reverse().map((e,idx)=>`<tr><td>${formatDate(e.date)}</td><td>${e.category}</td><td>${e.description}</td><td>${e.vendor}</td><td>‚Çπ${e.amount.toLocaleString()}</td><td>${e.receipt?`<a href="${e.receipt}" target="_blank">üìé View</a>`:'-'}</td><td><button class="btn btn-danger btn-sm" onclick="deleteExpense(${expenses.length-1-idx})">üóëÔ∏è</button></td></tr>`).join(''); } updateFinancialSummary(); }

    async function deleteExpense(index){ if(confirm('Delete this expense?')){ expenses.splice(index,1); await saveDataToServer(); loadExpenses(); alert('üóëÔ∏è Expense deleted!'); } }

    // ================== REPORTS / EXPORT ==================
    function downloadCSV(content, filename){ const blob=new Blob([content],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }
    function exportMembers(){ const csv='Flat,Name,Monthly Fee,Join Date,Status\n'+members.map(m=>`${m.flat},"${m.name}",${m.fee},${m.join},Active`).join('\n'); downloadCSV(csv, 'members.csv'); }
    function exportPayments(){ const csv='Date,Member,Month,Amount,Method,Notes\n'+payments.map(p=>{ const m=members.find(x=>x.id===p.memberId); return `${p.date},"${m?m.name:'Unknown'}",${p.month},${p.amount},${p.method},"${p.notes||''}"`; }).join('\n'); downloadCSV(csv, 'payments.csv'); }
    function exportExpenses(){ const csv='Date,Category,Description,Vendor,Amount\n'+expenses.map(e=>`${e.date},"${e.category}","${e.description}","${e.vendor}",${e.amount}`).join('\n'); downloadCSV(csv, 'expenses.csv'); }
    function exportReport(){ alert('Report export coming soon'); }

    function generateReport(){ const type=document.getElementById('reportType').value; if(!type){ alert('Please select a report type'); return; } let html=''; if(type==='summary') html=generateSummaryReport(); if(type==='defaulters') html=generateDefaultersReport(); if(type==='expenses') html=generateExpenseReport(); if(type==='monthly') html='<p>Monthly breakdown report</p>'; document.getElementById('reportContent').innerHTML=html; }
    function generateSummaryReport(){ const totalMembers=members.length; const totalCollected=payments.reduce((s,p)=>s+p.amount,0); const totalExpenses=expenses.reduce((s,e)=>s+e.amount,0); const net=totalCollected-totalExpenses; return `<div class=\"stats\"><div class=\"stat-box\"><h3>Total Members</h3><div class=\"value\">${totalMembers}</div></div><div class=\"stat-box success\"><h3>Total Collected</h3><div class=\"value\">‚Çπ${totalCollected.toLocaleString()}</div></div><div class=\"stat-box error\"><h3>Total Expenses</h3><div class=\"value\">‚Çπ${totalExpenses.toLocaleString()}</div></div><div class=\"stat-box ${net>=0?'success':'error'}\"><h3>Net Balance</h3><div class=\"value\">‚Çπ${net.toLocaleString()}</div></div></div>`; }
    function generateDefaultersReport(){ const now=new Date(); const currentMonth=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`; const defaulters=members.filter(m=>getUnpaidMonths(m.id,currentMonth).length>0); return `<h3>Payment Defaulters (${defaulters.length} members)</h3><table style=\"width:100%; margin-top:16px;\"><thead><tr><th>Flat</th><th>Name</th><th>Unpaid Months</th><th>Total Due</th></tr></thead><tbody>${defaulters.map(m=>{ const unpaid=getUnpaidMonths(m.id,currentMonth); const due=unpaid.length*m.fee; return `<tr><td>${m.flat}</td><td>${m.name}</td><td style=\\\"color: var(--color-error);\\\">${unpaid.join(', ')}</td><td>‚Çπ${due.toLocaleString()}</td></tr>`; }).join('')}</tbody></table>`; }
    function generateExpenseReport(){ const cat={}; expenses.forEach(e=>{ cat[e.category]=(cat[e.category]||0)+e.amount; }); const total=Object.values(cat).reduce((s,v)=>s+v,0); return `<h3>Expense Analysis by Category</h3><table style=\"width:100%; margin-top:16px;\"><thead><tr><th>Category</th><th>Total Amount</th><th>Percentage</th></tr></thead><tbody>${Object.entries(cat).map(([k,amt])=>`<tr><td>${k}</td><td>‚Çπ${amt.toLocaleString()}</td><td>${total?((amt/total)*100).toFixed(1):0}%</td></tr>`).join('')}</tbody></table>`; }

    // ================== MEMBER DETAILS ==================
    function hideMemberDetails(){ document.getElementById('memberDetailsModal').style.display='none'; }
    async function showMemberDetails(id){ const m=members.find(x=>x.id===id); if(!m) return; document.getElementById('memberDetailsName').textContent=`${m.name} (${m.flat})`; const memberPays=payments.filter(p=>p.memberId===id); const totalPaid=memberPays.reduce((s,p)=>s+p.amount,0); const joinDate=new Date(m.join); const today=new Date(); let expected=0; const cur=new Date(joinDate); while(cur<=today){ expected+=m.fee; cur.setMonth(cur.getMonth()+1);} const totalDue=expected-totalPaid; document.getElementById('memberTotalPaid').textContent='‚Çπ'+totalPaid.toLocaleString(); document.getElementById('memberTotalDue').textContent='‚Çπ'+totalDue.toLocaleString(); const list=document.getElementById('memberUnpaidMonths'); list.innerHTML=''; const currentMonth=`${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`; const unpaid=getUnpaidMonths(id,currentMonth); if(unpaid.length){ unpaid.forEach(mon=>{ const li=document.createElement('li'); li.style.display='flex'; li.style.justifyContent='space-between'; li.style.alignItems='center'; li.style.marginBottom='8px'; li.innerHTML=`<span style=\"color: var(--color-error);\">${mon}</span><button class=\"btn btn-primary btn-sm\" onclick=\"markMonthAsPaid(${id}, '${mon}')\">Mark as Paid</button>`; list.appendChild(li); }); } else { const li=document.createElement('li'); li.textContent='No unpaid months.'; li.style.color='var(--color-success)'; list.appendChild(li);} document.getElementById('memberDetailsModal').style.display='block'; }
    async function markMonthAsPaid(memberId, monthFormatted){ const m=members.find(x=>x.id===memberId); if(!m) return; const [monName,year]=monthFormatted.split(' '); const monthIndex=new Date(Date.parse(monName+" 1, 2000")).getMonth()+1; const month=`${year}-${String(monthIndex).padStart(2,'0')}`; const payment={ id: nextPaymentId++, memberId, month, amount:m.fee, method:'Cash', date:new Date().toISOString().split('T')[0], notes:'Marked as paid' }; payments.push(payment); await saveDataToServer(); alert(`üí∞ ${m.name} - ${monthFormatted} marked as paid!`); loadPayments(); loadMembers(); updateFinancialSummary(); showMemberDetails(memberId); }

    // ================== TOTALS ==================
    function updateFinancialSummary(){ const totalCollected=payments.reduce((s,p)=>s+p.amount,0); const totalExpenses=expenses.reduce((s,e)=>s+e.amount,0); const net=totalCollected-totalExpenses; document.getElementById('totalCollected').textContent='‚Çπ'+totalCollected.toLocaleString(); document.getElementById('totalExpenses').textContent='‚Çπ'+totalExpenses.toLocaleString(); document.getElementById('netBalance').textContent='‚Çπ'+net.toLocaleString(); const parent=document.getElementById('netBalance').closest('.stat-box'); parent.className='stat-box '+(net>=0?'success':'error'); }

    // ================== INIT & TESTS ==================
    document.addEventListener('DOMContentLoaded', async () => {
      const today=new Date(); const ym=`${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`; const todayStr=today.toISOString().split('T')[0]; const from=`${today.getFullYear()}-04`;
      const setVal=(id,val)=>{const el=document.getElementById(id); if(el) el.value=val;}; setVal('paymentMonth',ym); setVal('expenseDate',todayStr); setVal('newJoinDate',todayStr); setVal('reportFrom',from); setVal('reportTo',ym); setVal('reportMonth',ym);

      await loadDataFromServer();
      document.getElementById('totalMembers').textContent = members.length;
      loadMembers(); loadPayments(); loadExpenses(); updateMonthReport(); updateFinancialSummary();

      // Forms
      document.getElementById('paymentForm')?.addEventListener('submit', async function(e){ e.preventDefault(); const payment={ id: nextPaymentId++, memberId: parseInt(document.getElementById('paymentMember').value), month: document.getElementById('paymentMonth').value, amount: parseFloat(document.getElementById('paymentAmount').value), method: document.getElementById('paymentMethod').value, date: todayStr, notes: document.getElementById('paymentNotes').value }; payments.push(payment); await saveDataToServer(); loadPayments(); updateFinancialSummary(); this.reset(); alert('üí∞ Payment recorded successfully!'); });

      document.getElementById('expenseForm')?.addEventListener('submit', async function(e){ e.preventDefault(); const file=document.getElementById('expenseReceipt').files[0]; const done= async (b64)=>{ const expense={ date: document.getElementById('expenseDate').value, category: document.getElementById('expenseCategory').value, description: document.getElementById('expenseDescription').value, vendor: document.getElementById('expenseVendor').value, amount: parseFloat(document.getElementById('expenseAmount').value), receipt: b64||null }; expenses.push(expense); await saveDataToServer(); loadExpenses(); this.reset(); alert('üí∏ Expense added successfully!'); }; if(file){ const r=new FileReader(); r.onload=async e=>{ await done(e.target.result); }; r.readAsDataURL(file);} else await done(null); });

      document.getElementById('addMemberForm')?.addEventListener('submit', async function(e){ e.preventDefault(); const editId=this.dataset.editId; const file=document.getElementById('newPhoto').files[0]; const handle= async (b64)=>{ if(editId){ const m=members.find(x=>x.id===parseInt(editId)); if(m){ m.flat=document.getElementById('newFlat').value; m.name=document.getElementById('newName').value; m.fee=parseFloat(document.getElementById('newFee').value); m.join=document.getElementById('newJoinDate').value; if(b64) m.photo=b64; } alert('‚úèÔ∏è Member updated successfully!'); delete this.dataset.editId; } else { const m={ id: nextMemberId++, flat: document.getElementById('newFlat').value, name: document.getElementById('newName').value, fee: parseFloat(document.getElementById('newFee').value), join: document.getElementById('newJoinDate').value, photo: b64||'' }; members.push(m); document.getElementById('totalMembers').textContent = members.length; alert('üë• Member added successfully!'); } await saveDataToServer(); loadMembers(); hideAddMember(); this.reset(); }; if(file){ const r=new FileReader(); r.onload=async e=>{ await handle(e.target.result); }; r.readAsDataURL(file);} else await handle(null); });

      // Smoke tests (console)
      try{
        console.assert(typeof switchTab==='function','switchTab defined');
        const ov=document.getElementById('overview'); const mm=document.getElementById('members');
        switchTab('members'); console.assert(mm.classList.contains('active')&&!ov.classList.contains('active'),'Members tab activates');
        switchTab('overview'); console.assert(ov.classList.contains('active')&&!mm.classList.contains('active'),'Overview tab back');
        console.log('%cBasic smoke tests passed ‚úîÔ∏è','color:green');
      }catch(err){ console.error('Smoke tests failed:',err); }
    });
  </script>
</body>
</html>
